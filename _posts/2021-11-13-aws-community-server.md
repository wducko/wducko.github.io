---
layout: post
title: ! "대형 커뮤니티의 서버 구조는 어떻게 되어있을까?"
categories: [잡담]
excerpt: " "
comments: false
share: false
tags:
  - 잡담
date: '2021-11-13 11:15:41'
---

<p><code class="language-plaintext highlighter-rouge">출처 - <a href="https://pypy.dev/web/높은-트래픽-유저를-수용하는-확장-가능한-시스템-설계-with-aws/">https://pypy.dev/web/높은-트래픽-유저를-수용하는-확장-가능한-시스템-설계-with-aws/</a></code></p>

## 문득(사실 오래전부터) 궁금해진 커뮤니티 설계방법
최근 6개월동안 의문만 가지고 있고 해결되지 않는 이슈가 있었다.  
바로 대형 커뮤니티 사이트는 어떻게 구성 되어있길래 안 터지고 저렇게 잘만 돌아갈까?

더불어서 aws를 쓸까? 아니면 국내 cafe24같은 사이트를 쓸까?  
아니면 직접 회사에 서버실을 구축할까?  

서버는 간단하게. 정적서버, db서버, 이미지서버 3개로 구성하나?  
그런데 사이트 까보면 php에다가 딱히 XHR 호출 없이 그냥 바로 내려오던데. 뭐 어케하는걸까?

## php말고 내가 생각한대로라면 어케 구성하는걸까?
php가 아닌 3단 구성(정적, db, 이미지)이면 어떻게 구성하는걸까?

위 출처에 가면 아주 자세히 설명되어있다.  
요약하면 다음과 같다.  
(1번부터 점점 커진다. 유저 수가 점점 커진다고 생각하면 된다.)  
(이 요약본을 보는 것 보다는 위 출처글을 읽는 것을 추천한다.)  

1. 유저(동시 접속)가 적을 때는 `aws ec2`에 `정적, db`를 한 묶음으로 올린다.

2. `aws ec2`를 여러 개 띄우고 `aws ELB(Elastic Load Balancer)`로 연결한다. db는 `aws rds`로 분리하고 `aws ec2`가 `aws rds`를 바라보게한다.

3. `aws aurora`를 이용하여 `aws rds`를 여러 개로 분리한다.  
1개의 master와 여러개 slave로  
master는 write로 slave는 read로 쓰인다.  
master가 죽으면 slave중 첫 째가 master로 승격한다.  

4. 자주 안 바뀌는 DB는 `Redis`에 넣는다.  
`aws ec2`에서 `redis`에 들어갈지 `aws rds`에 들어갈지 판단해서 넣는다.

5. 이제 정적 자료를 `aws ec2`에서 `aws s3`로 분리한다.  
`(사실 내 기준에서는 너무 느린 분리가 아닌가 싶다. )`  

6. `aws SQS`라는 메세지 큐 서비스와 `aws ec2`를 묶어서 추가하여  
글쓰기 같은 DB에 쓰는 요청을 큐로 처리한다.

7. 6번까지로도 터진다면. 샤딩을 해야한다.  
지금까지 `aws rds`는 db 복사 개념이었던 것 같은데  
이제는 db 데이터를 분할로 쪼개어 저장하고  
`aws ec2`에서 0~9999까지는 1번 db로 연결. 이런 식으로 해줘야한다.  
그리고 그냥 분할이 아니다.  
트래픽이 균등하게 분산되어야한다.  
대충 나눠서 한 db로 트래픽이 쏠리면 의미가 없다.  
index를 홀수 짝수로 해서 db를 나누던가 해야 의미가 있어진다.

## 최종 이미지
![]({{ site.baseurl }}/assets/posts/aws/community.png)

## 아직도 해결되지 않는 php 대형 커뮤니티들의 서버 구성방법.
인벤은 가끔가다 터진다.  
하지만 DC, 펨코는 안 터진다.  

DC, 펨코는 터졌다는 이야기를 들어본 적이없다.  
인벤은 터지는 걸 직접 그리고 자주 목격한다.  

인벤은 url에 php가 없다.  
DC, 펨코는 url에 php가 있다.  

물론 HA라는 이중 레이어 구조로 되어있어서.  
한쪽 서버가 터지면 자동으로 서브 서버로 이동되어 유저는 터진걸 모르게 구성되어있겠지만  
그래도 실질적으로 어떻게 구성되어있는지는 아직도 궁금하다.
